# written by Connor Lydon

# loading packages and s3 keys #
library(here)
library(tidyverse)
library(sf)
library(aws.s3)
library(magrittr)
library(sf)
library(aws.s3)
library(here)
library(tidyr)
library(purrr)
library(osrm)
library(units)
library(data.table)
library(tmap)
library(ggplot2)

source(here::here("src", "s3_scripts", "s3_secret.r"))
download_path <- here::here("data", "temp")
b <- "vulnerabilitymapping"

#-----------------------

# loading osm data #
tgo_osm_tab_clean <- s3read_using(read_csv, object = "Clean_Data/Spatial_Data/TGO/Vector/tgo_osm_tab_clean.csv", bucket = b) #loading from s3
# tgo_osm_tab_clean %>% write_csv(here::here("data","temp","tgo_osm_tab_clean.csv")) #saving locally
#tgo_osm_tab_clean <- read.csv(here::here("data","temp","tgo_osm_tab_clean.csv")) #faster local runs

osm_geojson <- s3read_using(st_read, object = "Raw_Data/Spatial_Data/TGO/Raster/tgo_osm_geo.geojson", bucket = b) #loading from s3
# osm_geojson %>% st_write(here::here("data","temp", "tgo_osm_geo.geojson")) #saving locally
#osm_geojson <- st_read(here::here("data","temp", "tgo_osm_geo.geojson")) #faster local runs

copy <- osm_geojson
osm_geojson %<>% unique() #remove duplicates

# counting frequencies of tags  #
#looking for parks, transit centers, grocery stores, market areas, post offices, city halls, religious sites, & community centers
keyword_vec <- c("place of worship", "pharmacy", "marketplace", "church", "community centre",
                 "fountain", "bus station", "supermarket", "mosque", "post office",
                 "bicycle repair station", "library", "food court", "attraction", "townhall",
                 "religion", "ferry terminal", "chapel", "social facility", "government",
                 "mall", "temple", "bicycle parking", "transportation", "cathedral",
                 "fire station", "picnic site", "social centre", "train station", "Church",
                 "grocery", "shopping centre", "clinic", "higher education", "hospital",
                 "medical other", "music school", "primary/secondary", "zoo") 

raw_tag_count <- plyr::count(tgo_osm_tab_clean$building)  #counts the frequency of each tag 
colnames(raw_tag_count) <- c("building", "freq")
s3write_using(raw_tag_count, write.csv, object = "Clean_Data/Spatial_Data/TGO/Vector/osm_keys_summary.csv",
              bucket = "vulnerabilitymapping")

clean_tag_count <- raw_tag_count %>% filter(building %in% keyword_vec) #selects the rows that exist within the keyword vector

# merging selected buildings into the geojson # 

tgo_osm_tab_clean_keys <- tgo_osm_tab_clean[tgo_osm_tab_clean$building %in% keyword_vec,] #out of all the buildings pick the ones that have matching tags

tgo_osm_geo_clean_selected_tags <- dplyr::inner_join(osm_geojson, tgo_osm_tab_clean_keys)

# uploading to s3
s3write_using(tgo_osm_geo_clean_selected_tags, st_write, 
              object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_osm_geo_clean_selected_tags.geojson", 
              bucket = "vulnerabilityfidtogo")

# load capitol and adm3 data
capitol_loc <- data.frame(
  Name_1 = c("Centrale", "Kara", "Maritime", "Plateaux", "Savanes"),
  ID = c("Sokode", "Kara", "Lome", "Atakpame", "Dapaong"),
  Y = c(8.98333, 9.55111, 6.12874, 7.53333, 10.86225),
  X = c(1.13333, 1.18611, 1.22154, 1.13333, 0.20762)
)

tgo_shp <- s3read_using(st_read, object = "Clean_Data/Spatial_Data/Combined/Raster/combined.geojson",
                        bucket = b) %>% filter(ADM_0 == "TGO")

# determine the adm1 district for each point
tgo_adm1 <- tgo_shp %>% group_by(NAME_1) %>% dplyr::summarise()

osm_points <- st_join(tgo_osm_geo_clean_selected_tags, st_buffer(tgo_adm1, set_units(0.02, degree))) %>% 
  st_centroid() %>%
  distinct(id, building, NAME_1, geometry)

### get osm travel time (seconds) ###
get_dist_df <- function(adm1, points) {
  print(paste("Calculating", adm1))
  # capitol of each adm1
  capitol <- capitol_loc %>% filter(Name_1 == adm1) %>% select(ID, X, Y)
  
  # if points exceeds 100, divide into parts
  if(nrow(points) > 100) {
    points_lst <- list()
    niter <- ceiling(nrow(points) / 100)
    
    # slice into batches of 100 and caluclate distances for each batch
    lower <- 1
    for(i in 1:niter) {
      print(paste0("Progress: ", round(i/niter,2)*100, "%"))
      upper <- ifelse(lower + 99 > nrow(points), nrow(points), lower + 99)
      
      points_sub <- points %>% slice(lower:upper)
      points_lst[[i]] <- osrmTable(src = points_sub %>% select(ID, X, Y),
                                   dst = capitol, measure = "duration")$durations %>%
        as.data.frame()
      points_lst[[i]]$SSID <- rownames(points_lst[[i]])
      lower <- upper + 1
      Sys.sleep(0.5) # pause system for 0.5s to avoid overloading osrm server
    }
    
    # concatinate batches
    dist <- rbindlist(points_lst)
  }
  # if less than 100 points
  else {
    # calculate all points directly
    dist <- osrmTable(src = points %>% select(ID, X, Y),
                      dst = capitol, measure = "duration")$durations %>%
      as.data.frame()
    
    dist$SSID <- rownames(dist)
  }
  
  return(dist)
}

# nest each set of points into its respective district
ID <- osm_points$id
NAME_1 <- osm_points$NAME_1
osm_coords_nest <- osm_points %>%
  st_coordinates() %>%
  as.data.frame() %>%
  cbind(ID) %>%
  cbind(NAME_1) %>%
  group_by(NAME_1) %>%
  nest()

# calculate osm buildings to capitol
osm_coords_nest %<>%
  mutate(durations = map2(NAME_1, data, get_dist_df))

# calculate adm3 centroids to capitol
centroids <- tgo_shp %>% 
  st_centroid() %>%
  group_by(NAME_1) %>%
  nest()

centroids %<>%
  mutate(data = map(data, function(x) {
    ID <- x$SSID
    x %>% st_coordinates() %>% as.data.frame() %>% cbind(ID)
  })) %>%
  mutate(durations = map2(NAME_1, data, get_dist_df)) %>%
  mutate(durations = map(durations, function(x) {
    names(x)[1] <- "capitol_dist"
    x
  }))

# unnest centroid distances and join to original data
tgo_centroids <- centroids %>%
  select(NAME_1, durations) %>%
  unnest() %>%
  right_join(TGO_RIWI) %>%
  st_as_sf()

# convert capitols into geometries
capitol_sf <- st_as_sf(capitol_loc,
                 coords = c("X", "Y"),
                 crs = 4326)

### Plots
# maps of durations of centroids to capitols
tm_shape(tgo_centroids) +
  tm_polygons(col = "capitol_dist", palette = "-viridis",
              title = "Travel Time to Admin 1 Capitol\n(minutes)") + 
  tm_shape(capitol_sf) +
  tm_bubbles(size = 0.2, col = "red") +
  tm_layout(legend.title.size = 0.9, legend.outside = TRUE) 
names(tgo_centroids)

# scatter of travel time to capitol vs RIWI
ggplot(tgo_centroids, aes(x = capitol_dist, y = RIWI, color = NAME_1)) +
  geom_point(alpha = 0.5) +
  labs(x = "Travel Time to Admin 1 Capitol (minutes)", 
       y = "Relative Impoverished Wealth Index",
       title = paste0("Travel Time of Candidate Registration Sites to Capitol\n",
                      "vs. Relative Impoverished Wealth Index"),
       color = "Admin 1 Name") +
  theme_bw()
