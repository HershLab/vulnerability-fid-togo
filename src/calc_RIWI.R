library(aws.s3)
library(sf)
library(dplyr)
library(here)
library(tmap)
library(ggplot2)
library(rayshader)

source(here("src", "s3_scripts", "s3_secret.R"))

b <- "vulnerabilitymapping"

tgo_rwi <- s3read_using(st_read, object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_rwi_bing_tiles_23.geojson",
                        bucket = b)

tgo_shp <- s3read_using(st_read, object = "Clean_Data/Spatial_Data/Combined/Raster/combined.geojson",
                        bucket = b) %>% filter(ADM_0 == "TGO")

bottom_40 <- quantile(tgo_rwi$RWI, probs = .4)

tgo_shp_sub <- tgo_shp %>% select(-RWI)

tgo_joined <- st_join(tgo_shp_sub, tgo_rwi)

RWI_count <- tgo_joined %>% 
  group_by(SSID) %>% 
  summarise(RWI_count = n()) %>% 
  select(-geometry) %>%
  as.data.frame()


RIWI <- tgo_joined %>% 
  inner_join(RWI_count) %>% 
  mutate(POP_PER_RWI = POPULATION / RWI_count) %>%
  mutate(RIWI = ifelse(RWI <= bottom_40, POP_PER_RWI, 0)) %>%
  group_by(SSID) %>%
  summarise(RIWI = sum(RIWI)) %>%
  select(-geometry) %>%
  as.data.frame()

TGO_RIWI <- tgo_shp %>% inner_join(RIWI)
st_write(TGO_RIWI, here("TGO_RIWI.geojson"))


tm_shape(TGO_RIWI %>% mutate(log_RIWI = log(RIWI))) +
  tm_polygons("RIWI", palette = "viridis", 
              breaks = c(0,5000,10000,20000,30000,40000,50000)) + 
  tm_layout(legend.outside = T)


# Map
map <- ggplot(TGO_RIWI) +
  geom_sf(colour = "white") +
  geom_sf(aes(geometry = geometry, fill = RIWI)) +
  scale_fill_continuous(breaks = c(0,5000,10000,20000,30000,40000,50000), type = "viridis") + 
  theme(legend.position = "none", 
        axis.line=element_blank(), 
        axis.text.x=element_blank(), axis.title.x=element_blank(),
        axis.text.y=element_blank(), axis.title.y=element_blank(),
        axis.ticks=element_blank(), 
        panel.background = element_blank()) # Clean Everything

plot_gg(map,multicore = TRUE,width=5,height=5,scale=250,windowsize=c(2000,1000),
        zoom = 0.55, phi = 55, theta=-30, raytrace = T, triangulate = T, offset_edges = T, height_aes = "fill")
