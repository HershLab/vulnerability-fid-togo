library(here)
library(tidyverse)
library(sf)
library(aws.s3)

source(here::here("src", "s3_scripts", "s3_secret.r"))
source(here::here("src", "opencellid_key.r"))
download_path <- here::here("data", "temp")
b <- "vulnerabilityfidtogo"

#-----------------------

# loading osm data #
tgo_osm_tab_clean <- s3read_using(read_csv, object = "Clean_Data/Spatial_Data/TGO/Vector/tgo_osm_tab_clean.csv", bucket = b) #loading from s3
# tgo_osm_tab_clean %>% write_csv(here::here("data","temp","tgo_osm_tab_clean.csv")) #saving locally
#tgo_osm_tab_clean <- read.csv(here::here("data","temp","tgo_osm_tab_clean.csv")) #faster local runs

osm_geojson <- s3read_using(st_read, object = "Raw_Data/Spatial_Data/TGO/Raster/tgo_osm_geo.geojson", bucket = b) #loading from s3
# osm_geojson %>% st_write(here::here("data","temp", "tgo_osm_geo.geojson")) #saving locally
#osm_geojson <- st_read(here::here("data","temp", "tgo_osm_geo.geojson")) #faster local runs

osm_geojson %<>% unique() #remove duplicates

# counting frequencies of tags  #
#looking for parks, transit centers, grocery stores, market areas, post offices, city halls, religious sites, & community centers
keyword_vec <- c("place of worship", "pharmacy", "marketplace", "church", "community centre",
                 "fountain", "bus station", "supermarket", "mosque", "post office", "library", 
                 "food court", "attraction", "townhall", "religion", "ferry terminal", "chapel", 
                 "social facility", "government", "mall", "temple", "transportation", "cathedral",
                 "fire station", "picnic site", "social centre", "train station", "Church",
                 "grocery", "shopping centre", "clinic", "higher education", "hospital",
                 "medical other", "music school", "primary/secondary", "zoo") 

raw_tag_count <- plyr::count(tgo_osm_tab_clean$building)  #counts the frequency of each tag 
colnames(raw_tag_count) <- c("building", "freq")
s3write_using(raw_tag_count, write.csv, object = "Clean_Data/Spatial_Data/TGO/Vector/osm_keys_summary.csv",
              bucket = b)

clean_tag_count <- raw_tag_count %>% filter(building %in% keyword_vec) #selects the rows that exist within the keyword vector

# merging selected buildings into the geojson # 

tgo_osm_tab_clean_keys <- tgo_osm_tab_clean %>% filter(building %in% keyword_vec) #out of all the buildings pick the ones that have matching tags

tgo_osm_geo_clean_selected_tags <- dplyr::inner_join(osm_geojson, tgo_osm_tab_clean_keys)

# uploading to s3
s3write_using(tgo_osm_geo_clean_selected_tags, st_write, 
              object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_osm_geo_clean_selected_tags.geojson", 
              bucket = b)

tgo_shp <- s3read_using(st_read, bucket=b,
                        object="Clean_Data/Spatial_Data/TGO/Raster/tgo.geojson")

url <- paste0("https://opencellid.org/ocid/downloads?token=", opencellid_key,
              "&type=mcc&file=615.csv.gz")
download.file(url, destfile = here("data", "temp", "tgo_cell.csv"))

# net == 1 -> TogoCell
# net == 3 -> Moov
tgo_cell <- read.csv(here("data", "temp", "tgo_cell.csv"))

tgo_cell_sf <- tgo_cell %>%
  st_as_sf(coords = c("lon", "lat"),crs = 4326) %>%
  select(cell, range, geometry) %>%
  geo.buffer(r = 2000, sf = T)