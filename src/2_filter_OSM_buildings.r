library(here)
library(tidyverse)
library(sf)
library(aws.s3)
library(magrittr)
library(forcats)

source(here::here("src", "s3_scripts", "s3_secret.r"))
source(here::here("src", "opencellid_key.r"))
download_path <- here::here("data", "temp")
b <- "vulnerabilityfidtogo"

#-----------------------

# loading osm data #
tgo_osm_tab_clean <- s3read_using(read_csv, object = "Clean_Data/Spatial_Data/TGO/Vector/tgo_osm_tab_clean.csv", bucket = b) #loading from s3
# tgo_osm_tab_clean %>% write_csv(here::here("data","temp","tgo_osm_tab_clean.csv")) #saving locally
#tgo_osm_tab_clean <- read.csv(here::here("data","temp","tgo_osm_tab_clean.csv")) #faster local runs

osm_geojson <- s3read_using(st_read, object = "Raw_Data/Spatial_Data/TGO/Raster/tgo_osm_geo.geojson", bucket = b) #loading from s3
# osm_geojson %>% st_write(here::here("data","temp", "tgo_osm_geo.geojson")) #saving locally
#osm_geojson <- st_read(here::here("data","temp", "tgo_osm_geo.geojson")) #faster local runs

osm_geojson %<>% unique() #remove duplicates

# counting frequencies of tags  #
#looking for parks, transit centers, grocery stores, market areas, post offices, city halls, religious sites, & community centers
keyword_vec <- c("place of worship", "marketplace", "church", "community centre",
                 "bus station", "supermarket", "mosque", "post office", "library", 
                 "food court", "townhall", "religion", "ferry terminal", "chapel", 
                 "social facility", "government", "mall", "temple", "cathedral",
                 "fire station", "social centre", "train station", "Church",
                 "grocery", "shopping centre", "clinic", "higher education", "hospital",
                 "medical other", "primary/secondary") 


raw_tag_count <- plyr::count(tgo_osm_tab_clean$building)  #counts the frequency of each tag 
colnames(raw_tag_count) <- c("building", "freq")
s3write_using(raw_tag_count, write.csv, object = "Clean_Data/Spatial_Data/TGO/Vector/osm_keys_summary.csv",
              bucket = b)

clean_tag_count <- raw_tag_count %>% filter(building %in% keyword_vec) #selects the rows that exist within the keyword vector

# merging selected buildings into the geojson # 

tgo_osm_tab_clean_keys <- tgo_osm_tab_clean %>% filter(building %in% keyword_vec) #out of all the buildings pick the ones that have matching tags

tgo_osm_geo_clean_selected_tags <- dplyr::inner_join(osm_geojson, tgo_osm_tab_clean_keys)


# grouping similar tags

#defining similar keys
health_key_vec <- c("hospital", "clinic", "medical other")
education_key_vec <- c("higher education", "primary/secondary")
marketplace_key_vec <- c("food court", "grocery", "shopping centre", "supermarket", "marketplace", "mall")
religious_sites_key_vec <- c("cathedral", "chapel", "church", "Church", "place of worship", "religion", "temple", "mosque")
government_key_vec <- c("community centre", "government", "social centre", "social facility", "post office", "library", "townhall", "fire station")
transportation_key_vec <- c("train station", "ferry terminal", "bus station")

tgo_osm_geo_clean_selected_tags %<>%
  mutate(raw_building_tag = building,
         building = as.factor(building))

for (key in health_key_vec) {  #renaming the keys
  tgo_osm_geo_clean_selected_tags$building %<>% fct_recode(health = key)
}
for (key in education_key_vec) {
  tgo_osm_geo_clean_selected_tags$building %<>% fct_recode(education = key)
}
for (key in marketplace_key_vec) {
  tgo_osm_geo_clean_selected_tags$building %<>% fct_recode(marketplace = key)
}
for (key in religious_sites_key_vec) {
  tgo_osm_geo_clean_selected_tags$building %<>% fct_recode(religious_site = key)
}
for (key in government_key_vec) {
  tgo_osm_geo_clean_selected_tags$building %<>% fct_recode(government = key)
}
for (key in transportation_key_vec) {
  tgo_osm_geo_clean_selected_tags$building %<>% fct_recode(transportation_site = key)
}

tgo_osm_geo_clean_selected_tags <- tgo_osm_geo_clean_selected_tags[c(1,2,4,3)]

marche_sites <- data.frame(
  raw_building_tag = c("Marche De Zongo", "Marche de Kegue", "MARCHE Dâ€™AGBADAHONOU",
                       "Marche de LEGBASSITO", "Marche de langabou", "Marche de Tchebebe",
                       "Place du Marche des ignames", "Marche de Somdina Ba", "Marche de Mango",
                       "Marche de takpamba", "Marche de katchamba", "Marche de kidjaboun",
                       "Marche de namon", "Marche de Koka", "Grand Marche de Tchamba",
                       "Marche de Djarkpanga", "Marche de Tindjassi", "Marche d'Ayengre",
                       "MARCHE DE AGOMBIO MONO LAWAI", "Marche de Djerehouye", "Grand Marche d'Agbelouve"),
  Y = c(6.259067010130009, 6.207563967135589, 6.126222767148502, 
        6.27076412546629, 8.14126793349318, 8.458887760839934, 
        9.289102164467252, 9.6592489520743, 10.363867765665454,
        9.992552055711922, 9.903341296505085, 9.809587409816158, 
        9.7508364954033, 9.809587404216245, 9.034844910004598, 
        8.806168359141212, 8.677221256366611, 8.688081677164329, 
        8.450438804945271, 7.6383070886785145, 6.701142170680474),
  X = c(1.2090247370186404, 1.2436322335229764, 1.2211693807326254, 
        1.1512759510084791, 1.135818286172553, 0.9918482571157949,
        0.7684826898415653, 1.258216801930058, 0.4762025227849386,
        0.5710092858892504, 0.529735732746639, 0.4609464775089532,
        0.8106251893704667, 1.1098584496543995, 1.3999198066947631,
        0.5602940840436459, 0.44493763784501406, 1.0148534098673976,
        1.2194737724508768, 1.1787837692509169, 1.1612867581488544)
)

marche_sites$building <- "marche"
marche_sites$id <- 1:nrow(marche_sites)

marche_sites <- st_as_sf(marche_sites,
                 coords = c("X", "Y"),
                 crs = 4326)

tgo_osm_geo_clean_selected_tags <- tgo_osm_geo_clean_selected_tags %>% rbind(marche_sites) %>% arrange(id)

# uploading to s3
s3write_using(tgo_osm_geo_clean_selected_tags, st_write, 
              object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_clean_candidate_sites.geojson", 
              bucket = b)


