library(here)
library(tidyverse)
library(sf)
library(aws.s3)
library(magrittr)
library(forcats)

source(here::here("src", "s3_scripts", "s3_secret.r"))
source(here::here("src", "opencellid_key.r"))
download_path <- here::here("data", "temp")
b <- "vulnerabilityfidtogo"

#-----------------------

# loading osm data #
tgo_osm_tab_clean <- s3read_using(read_csv, object = "Clean_Data/Spatial_Data/TGO/Vector/tgo_osm_tab_clean.csv", bucket = b) #loading from s3
# tgo_osm_tab_clean %>% write_csv(here::here("data","temp","tgo_osm_tab_clean.csv")) #saving locally
#tgo_osm_tab_clean <- read.csv(here::here("data","temp","tgo_osm_tab_clean.csv")) #faster local runs

osm_geojson <- s3read_using(st_read, object = "Raw_Data/Spatial_Data/TGO/Raster/tgo_osm_geo.geojson", bucket = b) #loading from s3
# osm_geojson %>% st_write(here::here("data","temp", "tgo_osm_geo.geojson")) #saving locally
#osm_geojson <- st_read(here::here("data","temp", "tgo_osm_geo.geojson")) #faster local runs

osm_geojson %<>% unique() #remove duplicates

# counting frequencies of tags  #
#looking for parks, transit centers, grocery stores, market areas, post offices, city halls, religious sites, & community centers
keyword_vec <- c("place of worship", "marketplace", "church", "community centre",
                 "bus station", "supermarket", "mosque", "post office", "library", 
                 "food court", "townhall", "religion", "ferry terminal", "chapel", 
                 "social facility", "government", "mall", "temple", "cathedral",
                 "fire station", "social centre", "train station", "Church",
                 "grocery", "shopping centre", "clinic", "higher education", "hospital",
                 "medical other", "primary/secondary") 


raw_tag_count <- plyr::count(tgo_osm_tab_clean$building)  #counts the frequency of each tag 
colnames(raw_tag_count) <- c("building", "freq")
s3write_using(raw_tag_count, write.csv, object = "Clean_Data/Spatial_Data/TGO/Vector/osm_keys_summary.csv",
              bucket = b)

clean_tag_count <- raw_tag_count %>% filter(building %in% keyword_vec) #selects the rows that exist within the keyword vector

# merging selected buildings into the geojson # 

tgo_osm_tab_clean_keys <- tgo_osm_tab_clean %>% filter(building %in% keyword_vec) #out of all the buildings pick the ones that have matching tags

tgo_osm_geo_clean_selected_tags <- dplyr::inner_join(osm_geojson, tgo_osm_tab_clean_keys)


# grouping similar tags

#defining similar keys
health_key_vec <- c("hospital", "clinic", "medical other")
education_key_vec <- c("higher education", "primary/secondary")
marketplace_key_vec <- c("food court", "grocery", "shopping centre", "supermarket", "marketplace", "mall")
religious_sites_key_vec <- c("cathedral", "chapel", "church", "Church", "place of worship", "religion", "temple", "mosque")
government_key_vec <- c("community centre", "government", "social centre", "social facility", "post office", "library", "townhall", "fire station")
transportation_key_vec <- c("train station", "ferry terminal", "bus station")


tgo_osm_geo_clean_selected_tags$raw_building_tag <- tgo_osm_geo_clean_selected_tags$building #to keep the raw tags there for reference

tgo_osm_geo_clean_selected_tags$building_tag %<>% as.factor()

for (key in health_key_vec) {  #renaming the keys
  tgo_osm_geo_clean_selected_tags$building %<>% fct_recode(health = key)
}
for (key in education_key_vec) {
  tgo_osm_geo_clean_selected_tags$building %<>% fct_recode(education = key)
}
for (key in marketplace_key_vec) {
  tgo_osm_geo_clean_selected_tags$building %<>% fct_recode(marketplace = key)
}
for (key in religious_sites_key_vec) {
  tgo_osm_geo_clean_selected_tags$building %<>% fct_recode(religious_site = key)
}
for (key in government_key_vec) {
  tgo_osm_geo_clean_selected_tags$building %<>% fct_recode(government = key)
}
for (key in transportation_key_vec) {
  tgo_osm_geo_clean_selected_tags$building %<>% fct_recode(transportation_site = key)
}

tgo_osm_geo_clean_selected_tags <- tgo_osm_geo_clean_selected_tags[c(1,2,4,3)]


# uploading to s3
s3write_using(tgo_osm_geo_clean_selected_tags, st_write, 
              object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_osm_geo_clean_selected_tags.geojson", 
              bucket = b)

tgo_shp <- s3read_using(st_read, bucket=b,
                        object="Clean_Data/Spatial_Data/TGO/Raster/tgo.geojson")

url <- paste0("https://opencellid.org/ocid/downloads?token=", opencellid_key,
              "&type=mcc&file=615.csv.gz")
download.file(url, destfile = here("data", "temp", "tgo_cell.csv"))

# net == 1 -> TogoCell
# net == 3 -> Moov
tgo_cell <- read.csv(here("data", "temp", "tgo_cell.csv"))

tgo_cell_sf <- tgo_cell %>%
  st_as_sf(coords = c("lon", "lat"),crs = 4326) %>%
  select(cell, range, geometry) %>%
  geo.buffer(r = 2000, sf = T)