library(here)
library(tidyverse)
library(sf)
library(aws.s3)
library(tidyr)
library(purrr)
library(units)
library(spatialEco)
library(data.table)
library(tmap)
library(ggplot2)

source(here::here("src", "s3_scripts", "s3_secret.r"))
source(here::here("src", "opencellid_key.r"))
download_path <- here::here("data", "temp")
b <- "vulnerabilityfidtogo"

tgo_shp <- s3read_using(st_read, bucket=b,
                        object="Clean_Data/Spatial_Data/TGO/Raster/tgo.geojson")

url <- paste0("https://opencellid.org/ocid/downloads?token=", opencellid_key,
              "&type=mcc&file=615.csv.gz")
download.file(url, destfile = here("data", "temp", "tgo_cell.csv"))

# net == 1 -> TogoCell
# net == 3 -> Moov
tgo_cell <- read.csv(here("data", "temp", "tgo_cell.csv"))

tgo_cell_sf <- tgo_cell %>%
  st_as_sf(coords = c("lon", "lat"),crs = 4326) %>%
  select(cell, net, range, geometry) %>%
  geo.buffer(r = 2000, sf = T)

osm_candidates <- s3read_using(st_read, bucket = b,
                               object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_osm_geo_clean_selected_tags.geojson")

join <- osm_candidates %>%
  st_centroid() %>%
  st_join(tgo_cell_sf) 

osm_no_cell <- join %>% 
  filter(is.na(cell)) %>% 
  select(id, building)

osm_cell <- join %>% filter(!is.na(cell)) %>%
  group_by(id) %>%
  summarise(building = max(building), n_cell = n())

s3write_using(osm_no_cell, st_write, bucket = b,
              object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_candidate_mobile_sites.geojson")
s3write_using(osm_cell, st_write, bucket = b,
              object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_candidate_fixed_sites.geojson")

tgo_cell <- osm_cell %>%
  st_join(tgo_shp) %>% 
  group_by(ADM_3) %>%
  summarize(osm_fixed_count = n()) %>%
  as.data.frame() %>%
  select(-geometry)

tgo_no_cell <- osm_cell %>%
  st_join(tgo_shp) %>% 
  group_by(ADM_3) %>%
  summarize(osm_none_fixed_count = n()) %>%
  as.data.frame() %>%
  select(-geometry)

tgo_fixed <- tgo_shp %>%
  left_join(tgo_cell) %>%
  left_join(tgo_no_cell)

tm_shape(tgo_fixed) +
  tm_polygons(col = "osm_fixed_count", palette = "viridis", textNA = "None", 
              breaks = c(1, 21, 51, 71, 101, 201, 301, 900), 
              title = "Number of Candidate Sites\nwithin Range of Cell Tower") +
  tm_layout(legend.outside = T)

tm_shape(tgo_fixed) +
  tm_polygons(col = "osm_fixed_count", style = "log10_pretty", palette = "viridis", textNA = "None", 
              title = "Log of Number of Candidate Sites\nwithin 2km of a Cell Tower") +
  tm_layout(legend.outside = T)

tm_shape(tgo_fixed) +
  tm_polygons(col = "osm_none_fixed_count", style = "log10_pretty", palette = "viridis", textNA = "None", 
              title = "Log of Number of Candidate Sites\nnot within 2km of a Cell Tower") +
  tm_layout(legend.outside = T)

tm_shape(tgo_adm1) +
  tm_polygons() +
  tm_shape(tgo_cell_sf %>% mutate(net = as.factor(net))) +
  tm_dots(col = "net", palette = "Set1", 
          title = "Carrier", size = 0.1,
          labels = c("TogoCell", "Moov")) +
  tm_layout(legend.outside = T, 
            legend.text.size = 1.5,
            legend.title.size = 2)
  
tgo_cell_sf %>% group_by(net) %>% summarise(count = n())
tmaptools::palette_explorer()
