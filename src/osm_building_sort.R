# written by Connor Lydon

# loading packages and s3 keys #
library(plyr)
library(here)
library(dbplyr)
library(tidyverse)
library(sf)
library(aws.s3)
library(data.table)
library(magrittr)

source(here::here("src", "s3_scripts", "s3_secret.r"))
download_path <- here::here("data", "temp")
b <- "vulnerabilitymapping"
# #

#-----------------------

# loading objects #
# tgo_osm_tab_clean <- s3read_using(read_csv, object = "Clean_Data/Spatial_Data/TGO/Vector/tgo_osm_tab_clean.csv", bucket = b) #loading from s3
# tgo_osm_tab_clean %>% write_csv(here::here("data","temp","tgo_osm_tab_clean.csv")) #saving locally
tgo_osm_tab_clean <- read.csv(here::here("data","temp","tgo_osm_tab_clean.csv")) #faster local runs

# osm_geojson <- s3read_using(st_read, object = "Raw_Data/Spatial_Data/TGO/Raster/tgo_osm_geo.geojson", bucket = b) #loading from s3
# osm_geojson %>% st_write(here::here("data","temp", "tgo_osm_geo.geojson")) #saving locally
osm_geojson <- st_read(here::here("data","temp", "tgo_osm_geo.geojson")) #faster local runs
osm_geojson %<>% unique() #remove duplicates
# #

#-----------------------

# counting frequencies of tags  #
#looking for parks, transit centers, grocery stores, market areas, post offices, city halls, religious sites, & community centers
keyword_vec <- c("place of worship", "pharmacy", "marketplace", "church", "community centre",
                 "fountain", "bus station", "supermarket", "mosque", "post office",
                 "bicycle repair station", "library", "food court", "attraction", "townhall",
                 "religion", "ferry terminal", "chapel", "social facility", "government",
                 "mall", "temple", "bicycle parking", "transportation", "cathedral",
                 "fire station", "picnic site", "social centre", "train station", "Church",
                 "grocery", "shopping centre", "clinic", "higher education", "hospital",
                 "medical other", "music school", "primary/secondary", "zoo") 

tgo_osm_tab_clean$building  <- as.vector(tgo_osm_tab_clean$building)

raw_tag_count <- plyr::count(tgo_osm_tab_clean$building)  #counts the frequency of each tag 
colnames(raw_tag_count) <- c("building", "freq")

clean_tag_count <- raw_tag_count %>% filter(building %in% keyword_vec) #selects the rows that exist within the keyword vector
write.csv(clean_tag_count, here::here("data","clean_tag_count.csv")) 
# #

#-----------------------

# merging selected buildings into the geojson # 
tgo_osm_tab_clean_keys <- tgo_osm_tab_clean[tgo_osm_tab_clean$building %in% keyword_vec,] #out of all the buildings pick the ones that have matching tags

tgo_osm_geo_clean_selected_tags <- dplyr::inner_join(osm_geojson, tgo_osm_tab_clean_keys)
# #

#-----------------------

# uploading to s3
s3write_using(tgo_osm_geo_clean_selected_tags, st_write, 
              object = "Clean_Data/Spatial_Data/TGO/Raster/tgo_osm_geo_clean_selected_tags.geojson", 
              bucket = b)
# #





